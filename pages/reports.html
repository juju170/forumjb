<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laporan Warga üö®</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    .admin-container {
      padding: 16px;
      max-width: 900px;
      margin: auto;
    }

    h2 span#reportCount {
      color: #1976d2;
    }

    .search-box {
      display: flex;
      margin: 10px 0 20px 0;
    }

    #searchInput {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 8px 0 0 8px;
      outline: none;
    }

    #searchBtn {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
    }

    .report-actions {
      display: flex;
      gap: 10px;
      margin: 10px 0 15px 0;
    }

    .ignore-btn, .delete-btn {
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: transform 0.1s, opacity 0.2s;
    }

    .ignore-btn { background: #1976d2; }
    .delete-btn { background: #d32f2f; }

    .ignore-btn:hover, .delete-btn:hover {
      transform: scale(1.03);
      opacity: 0.9;
    }

    .report-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .report-card {
      border: 1px solid #ccc;
      background: #fafafa;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: transform 0.1s ease;
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .report-card:hover {
      transform: scale(1.01);
    }

    .report-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #ddd;
      flex-shrink: 0;
    }

    .report-info {
      flex: 1;
    }

    .report-info p {
      margin: 4px 0;
      font-size: 14px;
    }

    .select-report {
      margin-right: 8px;
      transform: scale(1.2);
      accent-color: #1976d2;
    }

    .no-report {
      color: #999;
      text-align: center;
      margin-top: 20px;
    }

    @media (max-width: 600px) {
      .report-card {
        flex-direction: column;
        align-items: flex-start;
      }
      .report-img {
        width: 100%;
        height: 200px;
      }
    }
  </style>
</head>
<body>
  <main class="admin-container">
    <h2>üö® Daftar Laporan Warga (<span id="reportCount">0</span>)</h2>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Cari laporan (pelapor, alasan, atau ID posting)..." />
      <button id="searchBtn">Cari</button>
    </div>

    <div class="report-actions">
      <button id="ignoreSelected" class="ignore-btn">üôà Abaikan</button>
      <button id="deletePosts" class="delete-btn">üî• Hapus Postingan</button>
    </div>

    <div id="reportList" class="report-list">
      <p>üìÇ Memuat laporan...</p>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { 
      getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // ‚öôÔ∏è GANTI DENGAN PUNYAMU
    const firebaseConfig = {
      apiKey: "AIzaSyC8uiIvWOZPcSZOzCGnlRMA7WJ7TIQfy5s",
    authDomain: "tts-indonesia-bf14e.firebaseapp.com",
    projectId: "tts-indonesia-bf14e",
    storageBucket: "tts-indonesia-bf14e.firebasestorage.app",
    messagingSenderId: "240052198349",
    appId: "1:240052198349:web:112553f8ca408b2fcc4284"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const reportList = document.getElementById("reportList");
    const reportCount = document.getElementById("reportCount");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");

    let allReports = [];

    // ==============================
    // üìã MUAT SEMUA LAPORAN
    // ==============================
    async function loadReports() {
      reportList.innerHTML = "<p>üìÇ Mengambil data laporan...</p>";

      const q = query(collection(db, "reports"), orderBy("time", "desc"));
      const snapshot = await getDocs(q);

      if (snapshot.empty) {
        reportList.innerHTML = "<p class='no-report'>Belum ada laporan.</p>";
        reportCount.textContent = "0";
        return;
      }

      allReports = snapshot.docs.map((docSnap) => ({
        id: docSnap.id,
        ...docSnap.data()
      }));

      renderReports(allReports);
    }

    // ==============================
    // üß± RENDER LAPORAN
    // ==============================
    function renderReports(reports) {
      reportList.innerHTML = "";
      let count = 0;

      reports.forEach((data) => {
        const card = document.createElement("div");
        card.classList.add("report-card");

        const imgPreview = data.image 
          ? `<img src="${data.image}" alt="Gambar Postingan" class="report-img" />`
          : `<div class="report-img" style="background:#eee;display:flex;align-items:center;justify-content:center;">üñºÔ∏è</div>`;

        card.innerHTML = `
          <input type="checkbox" class="select-report" data-id="${data.id}" data-post="${data.postId}" />
          ${imgPreview}
          <div class="report-info">
            <p><b>üìÑ Post ID:</b> ${data.postId}</p>
            <p><b>üë§ Pelapor:</b> ${data.reporter}</p>
            <p><b>üóíÔ∏è Alasan:</b> ${data.reason}</p>
            <p><b>üïí Waktu:</b> ${new Date(data.time).toLocaleString("id-ID")}</p>
          </div>
        `;
        reportList.appendChild(card);
        count++;
      });

      reportCount.textContent = count;
    }

    // ==============================
    // üîç FITUR PENCARIAN
    // ==============================
    searchBtn.addEventListener("click", () => {
      const keyword = searchInput.value.trim().toLowerCase();
      if (!keyword) return renderReports(allReports);

      const filtered = allReports.filter((r) =>
        (r.reporter || "").toLowerCase().includes(keyword) ||
        (r.reason || "").toLowerCase().includes(keyword) ||
        (r.postId || "").toLowerCase().includes(keyword)
      );

      renderReports(filtered);
      if (filtered.length === 0) {
        reportList.innerHTML = "<p class='no-report'>Tidak ada laporan yang cocok.</p>";
        reportCount.textContent = "0";
      }
    });

    // ==============================
    // üôà ABAIKAN LAPORAN
    // ==============================
    document.getElementById("ignoreSelected").addEventListener("click", async () => {
      const selected = Array.from(document.querySelectorAll(".select-report:checked"));
      if (selected.length === 0) return alert("‚ö†Ô∏è Pilih minimal satu laporan dulu!");
      if (!confirm(`Abaikan ${selected.length} laporan terpilih? (Posting tetap ada)`)) return;

      try {
        const deletions = selected.map((el) => deleteDoc(doc(db, "reports", el.dataset.id)));
        await Promise.all(deletions);
        selected.forEach((el) => el.closest(".report-card").remove());
        alert(`‚úÖ ${selected.length} laporan berhasil dihapus (posting tetap ada).`);
        updateCount();
      } catch (err) {
        console.error("‚ùå Gagal hapus laporan:", err);
      }
    });

    // ==============================
    // üî• HAPUS POSTINGAN + LAPORANNYA
    // ==============================
    document.getElementById("deletePosts").addEventListener("click", async () => {
      const selected = Array.from(document.querySelectorAll(".select-report:checked"));
      if (selected.length === 0) return alert("‚ö†Ô∏è Pilih minimal satu laporan dulu!");
      if (!confirm(`‚ö†Ô∏è Hapus ${selected.length} postingan yang dilaporkan?`)) return;

      try {
        const postIds = [...new Set(selected.map((el) => el.dataset.post))];
        const postDeletions = postIds.map((pid) => deleteDoc(doc(db, "posts", pid)));
        await Promise.all(postDeletions);

        const reportDeletions = selected.map((el) => deleteDoc(doc(db, "reports", el.dataset.id)));
        await Promise.all(reportDeletions);

        selected.forEach((el) => el.closest(".report-card").remove());
        alert(`üî• ${selected.length} laporan & postingan terkait berhasil dihapus.`);
        updateCount();
      } catch (err) {
        console.error("‚ùå Gagal hapus postingan dan laporan:", err);
      }
    });

    function updateCount() {
      const total = document.querySelectorAll(".report-card").length;
      reportCount.textContent = total;
      if (total === 0) {
        reportList.innerHTML = "<p class='no-report'>Belum ada laporan.</p>";
      }
    }

    loadReports();
  </script>
</body>
</html>
